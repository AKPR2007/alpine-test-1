name: CI
on:
  - pull_request
  - push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install qemu-utils
        run: |
          sudo apt-get update
          sudo apt-get install qemu-utils wget -y; cd ~/ ;wget https://raw.githubusercontent.com/alpinelinux/alpine-make-vm-image/v0.9.0/alpine-make-vm-image

      - uses: actions/checkout@v3

      - name: Build image
        run: |
          sudo bash ~/alpine-make-vm-image \
              --image-format qcow2 \
              --image-size 1024G \
              --branch 3.16 \
              --kernel-flavor lts \
              --packages "$(cat example/packages)" \
              alpine-$(date +%Y-%m-%d).qcow2
      - name: Desktop
        run: |
          export CRP="DISPLAY= /opt/google/chrome-remote-desktop/start-host --code="4/0AdQt8qgC-XcwCGlRQ2v4YYq2ipIyFEA1zAyU2mZTHWIoe_l40_aU2ceJnE21WodvgydRFg" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$(hostname)"
          export Pin="123456"
          sudo apt update
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo apt install ./chrome-remote-desktop_current_amd64.deb
          export DEBIAN_FRONTEND=noninteractive
          sudo apt install --assume-yes xfce4 desktop-base xfce4-terminal
          sudo bash -c 'echo \"exec /etc/X11/Xsession /usr/bin/xfce4-session\" > /etc/chrome-remote-desktop-session'
          sudo apt install --assume-yes xscreensaver
          sudo systemctl disable lightdm.service
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i *.deb
          sudo apt -f install -y
          sudo usermod -aG chrome-remote-desktop ${whoami}
          command = f"{CRP} --pin={Pin}"
          sudo su - ${whoami} -c '{command}'
          sudo  service chrome-remote-desktop start

      - name: Create SSH Access
        uses: mxschmitt/action-tmate@v3.11
